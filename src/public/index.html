<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top Variação Percentual Futuros USDⓈ-M</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #333;
            position: relative;
            height: 100vh;
            margin: 0;
        }

        h1 {
            padding: 1em 1em 0 1em;
            margin: 0;
        }

        table {
            width: 100%;
            padding: 20px;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        a {
            text-decoration: none;
            color: #007bff;
        }

        a:hover {
            text-decoration: underline;
        }

        #loading {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: none;
            text-align: center;
        }

        .dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            margin: 0 2px;
            background-color: #007bff;
            border-radius: 50%;
            animation: blink 1.5s infinite both;
        }

        .dot:nth-child(2) {
            animation-delay: 0.3s;
        }

        .dot:nth-child(3) {
            animation-delay: 0.6s;
        }

        @keyframes blink {
            0%,
            80%,
            100% {
                opacity: 0;
            }

            40% {
                opacity: 1;
            }
        }

        .tableWrapper {
            padding: 2em;
        }

        .alert-settings {
            padding: 1em;
            background-color: #fff;
            border: 1px solid #ddd;
            margin: 1em;
            border-radius: 5px;
        }

        .alert-settings label {
            margin-right: 10px;
        }

        .alert-settings input[type="range"] {
            margin-right: 10px;
        }

        /* Classe para destaque com fundo verde */
        .highlight {
            background-color: #d4edda; /* Verde claro */
        }
    </style>
</head>

<body>
    <h1>Top Variação Percentual Futuros USDⓈ-M</h1>

    <!-- Configuração de alerta -->
    <div class="alert-settings">
        <label for="alertThreshold">Alerta se variação percentual for maior que:</label>
        <input type="range" id="alertThreshold" name="alertThreshold" min="0" max="10" step="0.1" value="0.7">
        <span id="alertThresholdValue">0.7</span>%
    </div>

    <!-- Tabela que exibirá os resultados -->
    <div class="tableWrapper">
        <table id="disparityTable">
            <thead>
                <tr>
                    <th>Par</th>
                    <th>Volume</th>
                    <th>Preço Abertura</th>
                    <th>Preço Fechamento</th>
                    <th>Variação (%)</th>
                </tr>
            </thead>
            <tbody>
                <!-- Os dados serão preenchidos aqui dinamicamente -->
            </tbody>
        </table>
    </div>

    <!-- Ícone de carregamento -->
    <div id="loading">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
    </div>

    <script>
        const ws = new WebSocket('ws://localhost:3001'); // Conecta ao WebSocket

        let lastAlertTime = 0; // Tempo do último alerta
        const alertDelay = 10000; // 10 segundos de intervalo para novos alertas

        ws.onopen = () => {
            console.log('Conectado ao WebSocket');
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);

            const tableBody = document.getElementById('disparityTable').querySelector('tbody');
            tableBody.innerHTML = ''; // Limpa a tabela para adicionar os novos dados

            // Obtém o valor atual do input de range
            const alertThreshold = parseFloat(document.getElementById('alertThreshold').value);

            let alertNeeded = false; // Flag para indicar se o alerta é necessário

            data.forEach(({ symbol, priceChangePercent, open, close, volume }) => {
                const row = document.createElement('tr');
                const link = `https://www.binance.com/pt/futures/${symbol}`;

                // Adiciona a classe de destaque se a variação percentual atender ao critério
                if (priceChangePercent > alertThreshold || priceChangePercent < -alertThreshold) {
                    row.classList.add('highlight');
                    alertNeeded = true; // Define a flag para alerta
                }

                row.innerHTML = `
                    <td><a href="${link}" target="_blank">${symbol}</a></td>
                    <td>${volume}</td>
                    <td>${open}</td>
                    <td>${close}</td>
                    <td>${priceChangePercent.toFixed(2)}%</td>
                `;
                tableBody.appendChild(row);
            });

            // Verifica se é necessário emitir um alerta
            const currentTime = Date.now();
            if (alertNeeded && (currentTime - lastAlertTime >= alertDelay)) {
                const alertSound = new Audio('./sounds/alert.mp3'); // Som de alerta
                alertSound.play();
                lastAlertTime = currentTime; // Atualiza o tempo do último alerta
            }
        };

        ws.onclose = () => {
            console.log('Conexão com WebSocket encerrada');
        };

        ws.onerror = (error) => {
            console.error('Erro no WebSocket:', error);
        };

        // Atualiza o valor exibido ao lado do input de range
        document.getElementById('alertThreshold').addEventListener('input', (event) => {
            document.getElementById('alertThresholdValue').textContent = event.target.value;
        });
    </script>
</body>

</html>
